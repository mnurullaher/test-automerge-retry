name: Create Sync PR

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App name for the sync (e.g. test-app)'
        required: true
        default: 'test-app'
      change_file:
        description: 'Which file to change'
        required: true
        default: 'api.yaml'
        type: choice
        options:
          - api.yaml
          - config.yaml
      change_description:
        description: 'Description to add to the file'
        required: true
        default: 'Auto-synced change'

jobs:
  create-pr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    env:
      GH_TOKEN: ${{ secrets.PAT_TOKEN }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create branch and make changes
        run: |
          BRANCH_NAME="sync/${{ inputs.app_name }}-$(date +%Y%m%d-%H%M%S)"
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
          git checkout -b "$BRANCH_NAME"

          FILE_PATH="specs/${{ inputs.app_name }}/latest/${{ inputs.change_file }}"
          TIMESTAMP="$(date -u +%Y-%m-%dT%H:%M:%SZ)"

          if [ "${{ inputs.change_file }}" = "api.yaml" ]; then
            echo "openapi: 3.0.0" > "$FILE_PATH"
            echo "info:" >> "$FILE_PATH"
            echo "  title: ${{ inputs.app_name }} API" >> "$FILE_PATH"
            echo "  version: 1.0.0" >> "$FILE_PATH"
            echo "  description: ${{ inputs.change_description }}" >> "$FILE_PATH"
            echo "  x-synced-at: $TIMESTAMP" >> "$FILE_PATH"
            echo "paths: {}" >> "$FILE_PATH"
          else
            echo "# App configuration" > "$FILE_PATH"
            echo "app:" >> "$FILE_PATH"
            echo "  name: ${{ inputs.app_name }}" >> "$FILE_PATH"
            echo "  description: ${{ inputs.change_description }}" >> "$FILE_PATH"
            echo "  updated_at: $TIMESTAMP" >> "$FILE_PATH"
          fi

          git add "$FILE_PATH"
          git commit -m "Sync API specs: ${{ inputs.change_description }}"
          git push -u origin "$BRANCH_NAME"

      - name: Create Pull Request
        run: |
          gh pr create \
            --title "Sync API specs for ${{ inputs.app_name }}" \
            --body "Automated sync PR. File: ${{ inputs.change_file }}" \
            --base main \
            --head "$BRANCH_NAME"
